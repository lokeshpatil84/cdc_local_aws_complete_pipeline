name: Terraform Plan

on:
  workflow_run:
    workflows: ["CI - Validation"]
    types: [completed]
    branches: [main, dev, staging]

  workflow_dispatch:
    inputs:
      environment:
        description: 'Target Environment'
        required: true
        type: choice
        options: [dev, staging, prod]
      reason:
        description: 'Reason for manual plan'
        required: false
        type: string

  schedule:
    - cron: '0 6 * * *'

env:
  TERRAFORM_VERSION: "1.10.0"
  AWS_REGION: ap-south-1
  TF_LOCK_TIMEOUT: "300s"
  PROJECT_NAME: "cdc-pipeline"
  TF_PLUGIN_CACHE_DIR: ~/.terraform.d/plugin-cache

concurrency:
  group: tf-plan-${{ github.event.inputs.environment || github.ref_name }}
  cancel-in-progress: false

jobs:
  pre-check:
    name: Environment & Context
    runs-on: ubuntu-latest
    timeout-minutes: 5

    outputs:
      env: ${{ steps.env.outputs.env }}
      bucket: ${{ steps.env.outputs.bucket }}
      table: ${{ steps.env.outputs.table }}
      aws_access_key: ${{ steps.env.outputs.aws_access_key }}
      aws_secret_key: ${{ steps.env.outputs.aws_secret_key }}
      is_manual: ${{ steps.env.outputs.is_manual }}
      drift_check: ${{ steps.env.outputs.drift_check }}
      ci_passed: ${{ steps.ci-check.outputs.ci_passed || steps.ci-check-skipped.outputs.ci_passed }}

    steps:
      - name: Verify CI Success (Auto-trigger)
        id: ci-check
        if: github.event_name == 'workflow_run'
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
            echo "ci_passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "ci_passed=true" >> $GITHUB_OUTPUT

      - name: Skip CI Check (Manual Trigger)
        id: ci-check-skipped
        if: github.event_name != 'workflow_run'
        run: |
          echo "ci_passed=true" >> $GITHUB_OUTPUT

      - name: Determine Environment & Context
        id: env
        run: |
          set -euo pipefail

          IS_MANUAL="false"
          DRIFT_CHECK="false"

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            IS_MANUAL="true"
            ENV="${{ github.event.inputs.environment }}"

            if [[ ! "$ENV" =~ ^(dev|staging|prod)$ ]]; then
              echo "Invalid environment: $ENV"
              exit 1
            fi

          elif [ "${{ github.event_name }}" = "schedule" ]; then
            DRIFT_CHECK="true"
            ENV="prod"
            echo "Scheduled drift detection mode enabled"

          else
            BRANCH="${GITHUB_REF##*/}"
            case "$BRANCH" in
              dev)
                ENV="dev"
                ;;
              staging)
                ENV="staging"
                ;;
              main|master)
                ENV="prod"
                ;;
              *)
                echo "Unknown branch '$BRANCH' - defaulting to dev"
                ENV="dev"
                ;;
            esac
          fi

          echo "Target Environment: $ENV"
          echo "Manual Trigger: $IS_MANUAL"
          echo "Drift Check: $DRIFT_CHECK"

          echo "env=$ENV" >> $GITHUB_OUTPUT
          echo "is_manual=$IS_MANUAL" >> $GITHUB_OUTPUT
          echo "drift_check=$DRIFT_CHECK" >> $GITHUB_OUTPUT
          echo "bucket=cdc-pipeline-tfstate-$ENV" >> $GITHUB_OUTPUT
          echo "table=cdc-pipeline-terraform-lock-$ENV" >> $GITHUB_OUTPUT

          case "$ENV" in
            dev)
              echo "aws_access_key=AWS_DEV_ACCESS_KEY_ID" >> $GITHUB_OUTPUT
              echo "aws_secret_key=AWS_DEV_SECRET_ACCESS_KEY" >> $GITHUB_OUTPUT
              ;;
            staging)
              echo "aws_access_key=AWS_STAGING_ACCESS_KEY_ID" >> $GITHUB_OUTPUT
              echo "aws_secret_key=AWS_STAGING_SECRET_ACCESS_KEY" >> $GITHUB_OUTPUT
              ;;
            prod)
              echo "aws_access_key=AWS_PROD_ACCESS_KEY_ID" >> $GITHUB_OUTPUT
              echo "aws_secret_key=AWS_PROD_SECRET_ACCESS_KEY" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Log Configuration
        run: |
          echo "=========================================="
          echo "Terraform Plan Configuration"
          echo "=========================================="
          echo "Environment: ${{ steps.env.outputs.env }}"
          echo "S3 Bucket: ${{ steps.env.outputs.bucket }}"
          echo "DynamoDB Table: ${{ steps.env.outputs.table }}"
          echo "Is Manual: ${{ steps.env.outputs.is_manual }}"
          echo "Drift Check: ${{ steps.env.outputs.drift_check }}"
          echo "Triggered by: ${{ github.event_name }}"
          if [ -n "${{ github.event.inputs.reason || '' }}" ]; then
            echo "Reason: ${{ github.event.inputs.reason }}"
          fi
          echo "=========================================="

  terraform-bootstrap:
    name: Bootstrap Backend
    needs: pre-check
    runs-on: ubuntu-latest
    if: |
      needs.pre-check.result == 'success' &&
      needs.pre-check.outputs.drift_check != 'true'
    timeout-minutes: 15

    outputs:
      bootstrap_status: ${{ steps.set-status.outputs.bootstrap_status }}
      bucket_exists: ${{ steps.check.outputs.exists }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Prepare Plugin Cache
        run: mkdir -p ${{ env.TF_PLUGIN_CACHE_DIR }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets[needs.pre-check.outputs.aws_access_key] }}
          aws-secret-access-key: ${{ secrets[needs.pre-check.outputs.aws_secret_key] }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify AWS Access
        run: |
          echo "Verifying AWS credentials..."
          aws sts get-caller-identity

      - name: Check Existing Backend Resources
        id: check
        run: |
          set -e
          BUCKET="${{ needs.pre-check.outputs.bucket }}"
          TABLE="${{ needs.pre-check.outputs.table }}"

          echo "Checking backend resources..."

          BUCKET_EXISTS="false"
          TABLE_EXISTS="false"

          if aws s3api head-bucket --bucket "$BUCKET" 2>/dev/null; then
            echo "S3 bucket exists: $BUCKET"
            BUCKET_EXISTS="true"
          else
            echo "S3 bucket missing: $BUCKET"
          fi

          if aws dynamodb describe-table --table-name "$TABLE" --region ${{ env.AWS_REGION }} 2>/dev/null >/dev/null; then
            echo "DynamoDB table exists: $TABLE"
            TABLE_EXISTS="true"
          else
            echo "DynamoDB table missing: $TABLE"
          fi

          if [ "$BUCKET_EXISTS" = "true" ] && [ "$TABLE_EXISTS" = "true" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Bootstrap Terraform Backend
        if: steps.check.outputs.exists == 'false'
        id: bootstrap-apply
        working-directory: terraform-bootstrap
        run: |
          ENV="${{ needs.pre-check.outputs.env }}"

          echo "Initializing bootstrap Terraform..."
          terraform init -input=false

          echo "Planning bootstrap..."
          terraform plan \
            -out=tfplan-bootstrap \
            -input=false \
            -var="environment=$ENV" \
            -var="bucket_name=${{ needs.pre-check.outputs.bucket }}" \
            -var="dynamodb_table_name=${{ needs.pre-check.outputs.table }}" \
            -var="aws_region=${{ env.AWS_REGION }}" \
            -var="project_name=${{ env.PROJECT_NAME }}" \
            -lock-timeout=${{ env.TF_LOCK_TIMEOUT }}

          echo "Applying bootstrap..."
          terraform apply \
            -auto-approve \
            -lock-timeout=${{ env.TF_LOCK_TIMEOUT }} \
            tfplan-bootstrap

      - name: Wait for AWS Propagation
        if: steps.check.outputs.exists == 'false'
        run: |
          echo "Waiting for AWS propagation..."
          for i in 1 2 3 4 5; do
            if aws s3api head-bucket --bucket "${{ needs.pre-check.outputs.bucket }}" 2>/dev/null; then
              echo "Bucket confirmed ready"
              exit 0
            fi
            echo "Waiting for bucket... attempt $i/5"
            sleep 5
          done
          echo "Timeout waiting for bucket propagation"
          exit 1

      - name: Set Bootstrap Status
        id: set-status
        run: |
          if [ "${{ steps.check.outputs.exists }}" = "true" ]; then
            echo "bootstrap_status=skipped_existing" >> $GITHUB_OUTPUT
            echo "Bootstrap skipped - resources already exist"
          elif [ "${{ steps.bootstrap-apply.outcome }}" = "success" ]; then
            echo "bootstrap_status=created" >> $GITHUB_OUTPUT
            echo "Bootstrap completed successfully"
          else
            echo "bootstrap_status=failed" >> $GITHUB_OUTPUT
            echo "Bootstrap failed"
            exit 1
          fi

  terraform-plan:
    name: Generate Terraform Plan
    needs: [pre-check, terraform-bootstrap]
    runs-on: ubuntu-latest
    if: needs.terraform-bootstrap.result == 'success'
    timeout-minutes: 30

    outputs:
      has_changes: ${{ steps.plan.outputs.has_changes }}
      plan_id: ${{ steps.plan.outputs.plan_id }}
      drift_detected: ${{ steps.plan.outputs.drift_detected }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Prepare Plugin Cache
        run: mkdir -p ${{ env.TF_PLUGIN_CACHE_DIR }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Setup Infracost (Optional)
        if: vars.INFRACOST_API_KEY != ''
        uses: infracost/actions/setup@v2
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets[needs.pre-check.outputs.aws_access_key] }}
          aws-secret-access-key: ${{ secrets[needs.pre-check.outputs.aws_secret_key] }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        id: init
        working-directory: terraform
        continue-on-error: true
        run: |
          echo "Initializing Terraform..."
          terraform init \
            -backend-config="bucket=${{ needs.pre-check.outputs.bucket }}" \
            -backend-config="key=terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ needs.pre-check.outputs.table }}" \
            -backend-config="encrypt=true" \
            -lock-timeout=${{ env.TF_LOCK_TIMEOUT }}

      - name: Terraform Init Retry
        if: steps.init.outcome == 'failure'
        working-directory: terraform
        run: |
          echo "Init failed, retrying in 20s..."
          sleep 20
          terraform init \
            -backend-config="bucket=${{ needs.pre-check.outputs.bucket }}" \
            -backend-config="key=terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ needs.pre-check.outputs.table }}" \
            -backend-config="encrypt=true" \
            -lock-timeout=${{ env.TF_LOCK_TIMEOUT }}

      - name: Terraform Plan
        id: plan
        working-directory: terraform
        env:
          TF_VAR_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
        run: |
          ENV="${{ needs.pre-check.outputs.env }}"
          IS_DRIFT="${{ needs.pre-check.outputs.drift_check }}"
          PLAN_ID="tfplan-${ENV}-${{ github.run_id }}"

          echo "Generating Terraform plan..."
          echo "Plan ID: $PLAN_ID"

          set +e
          terraform plan \
            -out=${PLAN_ID} \
            -var="environment=${ENV}" \
            -var="project_name=${{ env.PROJECT_NAME }}" \
            -lock-timeout=${{ env.TF_LOCK_TIMEOUT }} \
            -detailed-exitcode 2>&1 | tee plan_raw.log

          EXIT_CODE=${PIPESTATUS[0]}
          set -e

          sed 's/[0-9a-fA-F]\{32,\}/****REDACTED****/g' plan_raw.log > plan.log

          case $EXIT_CODE in
            0)
              echo "No changes detected"
              echo "has_changes=false" >> $GITHUB_OUTPUT
              echo "drift_detected=false" >> $GITHUB_OUTPUT
              ;;
            1)
              echo "Plan failed"
              cat plan.log
              exit 1
              ;;
            2)
              echo "Changes detected"
              echo "has_changes=true" >> $GITHUB_OUTPUT
              echo "plan_id=${PLAN_ID}" >> $GITHUB_OUTPUT

              if [ "$IS_DRIFT" = "true" ]; then
                echo "drift_detected=true" >> $GITHUB_OUTPUT
                echo "DRIFT DETECTED in scheduled check!"
              else
                echo "drift_detected=false" >> $GITHUB_OUTPUT
              fi

              terraform show -no-color ${PLAN_ID} > plan_summary.txt
              ;;
          esac

      - name: Generate Plan Summary Comment
        if: steps.plan.outputs.has_changes == 'true'
        working-directory: terraform
        run: |
          cat << 'EOF' > plan_comment.md
          ## Terraform Plan Summary

          **Environment:** ${{ needs.pre-check.outputs.env }}
          **Run ID:** ${{ github.run_id }}
          **Triggered by:** ${{ github.event_name }}

          <details><summary>Click to expand plan details</summary>

          ```terraform
          $(head -300 plan_summary.txt)
          ```

          </details>

          **Next Steps:**
          - Review the plan above
          - To apply: Run `Terraform Deploy` workflow manually
          EOF

      - name: Infracost Cost Estimate
        if: steps.plan.outputs.has_changes == 'true' && vars.INFRACOST_API_KEY != ''
        working-directory: terraform
        continue-on-error: true
        run: |
          echo "Generating cost estimate..."
          infracost breakdown \
            --path . \
            --format json \
            --out-file infracost.json

          infracost output \
            --path infracost.json \
            --format github-comment \
            --out-file infracost_comment.md

      - name: Upload Plan Artifacts
        if: steps.plan.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.plan.outputs.plan_id }}
          path: |
            terraform/${{ steps.plan.outputs.plan_id }}
            terraform/plan_summary.txt
            terraform/plan_comment.md
            terraform/infracost_comment.md
          retention-days: 5
          if-no-files-found: warn

      - name: Drift Detection Alert
        if: steps.plan.outputs.drift_detected == 'true'
        run: |
          echo "INFRASTRUCTURE DRIFT DETECTED"
          echo "=========================================="
          echo "Environment: ${{ needs.pre-check.outputs.env }}"
          echo "Manual intervention required!"
          echo "Review the plan artifacts for details"
          echo "=========================================="
          exit 1

  plan-status:
    name: Plan Status
    needs: [terraform-plan, pre-check]
    runs-on: ubuntu-latest
    if: needs.pre-check.result == 'success'

    steps:
      - name: Report Status
        run: |
          echo "=========================================="
          echo "Terraform Plan Workflow Complete"
          echo "=========================================="
          echo "Status: ${{ needs.terraform-plan.result }}"
          echo "Environment: ${{ needs.pre-check.outputs.env }}"
          echo "Has Changes: ${{ needs.terraform-plan.outputs.has_changes }}"
          echo "Drift Detected: ${{ needs.terraform-plan.outputs.drift_detected }}"

          if [ "${{ needs.terraform-plan.outputs.has_changes }}" == "true" ]; then
            echo ""
            echo "Plan artifact saved: ${{ needs.terraform-plan.outputs.plan_id }}"
            echo "Run 'Terraform Deploy' workflow to apply changes"
          fi
          echo "=========================================="

