name: Terraform Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target Environment'
        required: true
        type: choice
        options: [dev, staging, prod]
      action:
        description: 'Action to Perform'
        required: true
        type: choice
        options: [apply, destroy]
      plan_id:
        description: 'Plan Artifact ID (from Terraform Plan workflow)'
        required: false
        type: string
      reason:
        description: 'Reason for deployment (Required for prod)'
        required: false
        type: string

env:
  TERRAFORM_VERSION: "1.10.0"
  AWS_REGION: ap-south-1
  TF_LOCK_TIMEOUT: "300s"
  PROJECT_NAME: "cdc-pipeline"
  TF_PLUGIN_CACHE_DIR: ~/.terraform.d/plugin-cache

concurrency:
  group: tf-deploy-${{ github.event.inputs.environment }}
  cancel-in-progress: false

jobs:
  pre-check:
    name: Validate Deployment Context
    runs-on: ubuntu-latest
    timeout-minutes: 5

    outputs:
      env: ${{ steps.env.outputs.env }}
      bucket: ${{ steps.env.outputs.bucket }}
      table: ${{ steps.env.outputs.table }}
      aws_access_key: ${{ steps.env.outputs.aws_access_key }}
      aws_secret_key: ${{ steps.env.outputs.aws_secret_key }}
      action: ${{ steps.env.outputs.action }}
      plan_id: ${{ steps.env.outputs.plan_id }}

    steps:
      - name: Validate Inputs
        run: |
          ENV="${{ github.event.inputs.environment }}"
          ACTION="${{ github.event.inputs.action }}"
          REASON="${{ github.event.inputs.reason }}"
          PLAN_ID="${{ github.event.inputs.plan_id }}"

          echo "=========================================="
          echo "Validating deployment inputs..."
          echo "=========================================="
          echo "Environment: $ENV"
          echo "Action: $ACTION"

          if [[ ! "$ENV" =~ ^(dev|staging|prod)$ ]]; then
            echo "Invalid environment: $ENV"
            exit 1
          fi

          if [[ ! "$ACTION" =~ ^(apply|destroy)$ ]]; then
            echo "Invalid action: $ACTION"
            exit 1
          fi

          if [ "$ENV" = "prod" ] && [ -z "$REASON" ]; then
            echo "Production deployments require a reason"
            echo "Please provide a reason for this deployment"
            exit 1
          fi

          if [ "$ACTION" = "apply" ] && [ -z "$PLAN_ID" ]; then
            echo "Warning: No plan_id provided for apply"
            echo "You should run 'Terraform Plan' first and provide the plan ID"
            echo "Continuing anyway (will create new plan)..."
          fi

          echo "Input validation passed"

      - name: Determine Environment Configuration
        id: env
        run: |
          ENV="${{ github.event.inputs.environment }}"
          ACTION="${{ github.event.inputs.action }}"
          PLAN_ID="${{ github.event.inputs.plan_id }}"

          echo "env=$ENV" >> $GITHUB_OUTPUT
          echo "action=$ACTION" >> $GITHUB_OUTPUT
          echo "plan_id=$PLAN_ID" >> $GITHUB_OUTPUT
          echo "bucket=cdc-pipeline-tfstate-$ENV" >> $GITHUB_OUTPUT
          echo "table=cdc-pipeline-terraform-lock-$ENV" >> $GITHUB_OUTPUT

          case "$ENV" in
            dev)
              echo "aws_access_key=AWS_DEV_ACCESS_KEY_ID" >> $GITHUB_OUTPUT
              echo "aws_secret_key=AWS_DEV_SECRET_ACCESS_KEY" >> $GITHUB_OUTPUT
              ;;
            staging)
              echo "aws_access_key=AWS_STAGING_ACCESS_KEY_ID" >> $GITHUB_OUTPUT
              echo "aws_secret_key=AWS_STAGING_SECRET_ACCESS_KEY" >> $GITHUB_OUTPUT
              ;;
            prod)
              echo "aws_access_key=AWS_PROD_ACCESS_KEY_ID" >> $GITHUB_OUTPUT
              echo "aws_secret_key=AWS_PROD_SECRET_ACCESS_KEY" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Log Deployment Configuration
        run: |
          echo "=========================================="
          echo "Deployment Configuration"
          echo "=========================================="
          echo "Environment: ${{ steps.env.outputs.env }}"
          echo "Action: ${{ steps.env.outputs.action }}"
          echo "S3 Bucket: ${{ steps.env.outputs.bucket }}"
          echo "DynamoDB Table: ${{ steps.env.outputs.table }}"
          echo "Plan ID: ${{ steps.env.outputs.plan_id }}"
          if [ -n "${{ github.event.inputs.reason }}" ]; then
            echo "Reason: ${{ github.event.inputs.reason }}"
          fi
          echo "Triggered by: ${{ github.actor }}"
          echo "=========================================="

  prod-destroy-blocker:
    name: Production Destroy Protection
    needs: pre-check
    runs-on: ubuntu-latest
    if: |
      needs.pre-check.outputs.action == 'destroy' &&
      needs.pre-check.outputs.env == 'prod'

    steps:
      - name: Block Production Destroy
        run: |
          echo "PRODUCTION DESTROY BLOCKED"
          echo "=========================================="
          echo "This action is not allowed via workflow."
          echo ""
          echo "Manual steps required:"
          echo "1. Elevate to break-glass role"
          echo "2. Disable termination protection manually"
          echo "3. Run destroy from secure admin terminal"
          echo "4. Document in change log"
          echo ""
          echo "Event logged for security audit."
          echo "=========================================="
          exit 1

  terraform-apply:
    name: Terraform Apply
    needs: [pre-check, prod-destroy-blocker]
    runs-on: ubuntu-latest
    if: |
      needs.pre-check.outputs.action == 'apply' &&
      needs.pre-check.result == 'success'
    timeout-minutes: 45

    environment:
      name: ${{ needs.pre-check.outputs.env }}
      url: ${{ steps.outputs.outputs.service_url }}

    steps:
      - name: Deployment Context
        run: |
          echo "=========================================="
          echo "Starting Terraform Apply"
          echo "=========================================="
          echo "Environment: ${{ needs.pre-check.outputs.env }}"
          if [ -n "${{ github.event.inputs.reason }}" ]; then
            echo "Reason: ${{ github.event.inputs.reason }}"
          fi

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Prepare Plugin Cache
        run: mkdir -p ${{ env.TF_PLUGIN_CACHE_DIR }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets[needs.pre-check.outputs.aws_access_key] }}
          aws-secret-access-key: ${{ secrets[needs.pre-check.outputs.aws_secret_key] }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        working-directory: terraform
        run: |
          terraform init \
            -backend-config="bucket=${{ needs.pre-check.outputs.bucket }}" \
            -backend-config="key=terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ needs.pre-check.outputs.table }}" \
            -backend-config="encrypt=true" \
            -lock-timeout=${{ env.TF_LOCK_TIMEOUT }}

      - name: Backup State to Secure S3
        working-directory: terraform
        run: |
          ENV="${{ needs.pre-check.outputs.env }}"
          RUN_ID="${{ github.run_id }}"
          TIMESTAMP=$(date +%s)
          BACKUP_KEY="backups/${ENV}/${RUN_ID}-${TIMESTAMP}.tfstate"

          echo "Creating encrypted state backup..."
          terraform state pull > state-backup-${RUN_ID}.json

          if [ ! -s state-backup-${RUN_ID}.json ]; then
            echo "Warning: State backup is empty"
          else
            aws s3 cp state-backup-${RUN_ID}.json \
              s3://cdc-pipeline-tfstate-${ENV}/${BACKUP_KEY} \
              --sse AES256

            echo "State backup uploaded to S3: ${BACKUP_KEY}"
            echo "backup_key=${BACKUP_KEY}" >> $GITHUB_OUTPUT
          fi

          rm -f state-backup-${RUN_ID}.json
          echo "Local state file removed from runner"

      - name: Download Plan Artifact (if provided)
        if: needs.pre-check.outputs.plan_id != ''
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.pre-check.outputs.plan_id }}
          path: terraform

      - name: Terraform Apply
        id: apply
        working-directory: terraform
        env:
          TF_VAR_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
        run: |
          PLAN_ID="${{ needs.pre-check.outputs.plan_id }}"
          ENV="${{ needs.pre-check.outputs.env }}"

          if [ -n "$PLAN_ID" ] && [ -f "$PLAN_ID" ]; then
            echo "Applying pre-generated plan: $PLAN_ID"
            terraform apply -auto-approve -lock-timeout=${{ env.TF_LOCK_TIMEOUT }} "$PLAN_ID"
          else
            echo "Running apply with auto-approval..."
            terraform apply -auto-approve \
              -var="environment=${ENV}" \
              -var="project_name=${{ env.PROJECT_NAME }}" \
              -lock-timeout=${{ env.TF_LOCK_TIMEOUT }}

      - name: Capture Outputs
        id: outputs
        working-directory: terraform
        run: |
          echo "Deployment Outputs:"
          terraform output -json 2>/dev/null | jq . || echo "{}"

          SERVICE_URL=$(terraform output -raw service_url 2>/dev/null || echo "")
          DB_ENDPOINT=$(terraform output -raw database_endpoint 2>/dev/null || echo "")

          if [ -n "$SERVICE_URL" ]; then
            echo "service_url=${SERVICE_URL}" >> $GITHUB_OUTPUT
            echo "Service URL: ${SERVICE_URL}"
          fi
          if [ -n "$DB_ENDPOINT" ]; then
            echo "db_endpoint=${DB_ENDPOINT}" >> $GITHUB_OUTPUT
            echo "Database: ${DB_ENDPOINT}"
          fi

      - name: Deployment Success Notification
        if: success() && needs.pre-check.outputs.action == 'apply'
        run: |
          echo "=========================================="
          echo "Deployment Successful!"
          echo "=========================================="
          echo "Environment: ${{ needs.pre-check.outputs.env }}"
          if [ -n "${{ steps.outputs.outputs.service_url }}" ]; then
            echo "Service URL: ${{ steps.outputs.outputs.service_url }}"
          fi
          echo "=========================================="

  terraform-destroy:
    name: Terraform Destroy
    needs: [pre-check, prod-destroy-blocker]
    runs-on: ubuntu-latest
    if: |
      needs.pre-check.outputs.action == 'destroy' &&
      needs.pre-check.outputs.env != 'prod' &&
      needs.pre-check.result == 'success'
    timeout-minutes: 30

    environment:
      name: ${{ needs.pre-check.outputs.env }}-destroy

    steps:
      - name: Destroy Warning
        run: |
          echo "DESTROYING INFRASTRUCTURE"
          echo "=========================================="
          echo "Environment: ${{ needs.pre-check.outputs.env }}"
          echo "This action is IRREVERSIBLE!"
          echo "=========================================="
          sleep 5

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Prepare Plugin Cache
        run: mkdir -p ${{ env.TF_PLUGIN_CACHE_DIR }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets[needs.pre-check.outputs.aws_access_key] }}
          aws-secret-access-key: ${{ secrets[needs.pre-check.outputs.aws_secret_key] }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        working-directory: terraform
        run: |
          terraform init \
            -backend-config="bucket=${{ needs.pre-check.outputs.bucket }}" \
            -backend-config="key=terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ needs.pre-check.outputs.table }}" \
            -backend-config="encrypt=true" \
            -lock-timeout=${{ env.TF_LOCK_TIMEOUT }}

      - name: Backup State to Secure S3
        working-directory: terraform
        run: |
          ENV="${{ needs.pre-check.outputs.env }}"
          RUN_ID="${{ github.run_id }}"
          TIMESTAMP=$(date +%s)
          BACKUP_KEY="backups/${ENV}/${RUN_ID}-${TIMESTAMP}.tfstate"

          echo "Creating pre-destroy state backup..."
          terraform state pull > state-before-destroy-${RUN_ID}.json

          aws s3 cp state-before-destroy-${RUN_ID}.json \
            s3://cdc-pipeline-tfstate-${ENV}/${BACKUP_KEY} \
            --sse AES256

          echo "State backup uploaded to S3: ${BACKUP_KEY}"
          echo "backup_key=${BACKUP_KEY}" >> $GITHUB_OUTPUT

          rm -f state-before-destroy-${RUN_ID}.json
          echo "Local state file removed from runner"

      - name: Terraform Destroy
        working-directory: terraform
        run: |
          ENV="${{ needs.pre-check.outputs.env }}"
          echo "Destroying infrastructure..."
          terraform destroy \
            -auto-approve \
            -var="environment=${ENV}" \
            -var="project_name=${{ env.PROJECT_NAME }}" \
            -lock-timeout=${{ env.TF_LOCK_TIMEOUT }}

      - name: Destroy Complete
        run: |
          echo "=========================================="
          echo "Infrastructure Destroyed"
          echo "Environment: ${{ needs.pre-check.outputs.env }}"
          echo "=========================================="

  notify:
    name: Deployment Notification
    needs: [terraform-apply, terraform-destroy, pre-check]
    if: always() && needs.pre-check.result == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Determine Final Status
        id: status
        run: |
          ACTION="${{ needs.pre-check.outputs.action }}"
          APPLY_RESULT="${{ needs.terraform-apply.result }}"
          DESTROY_RESULT="${{ needs.terraform-destroy.result }}"

          echo "Action: $ACTION"
          echo "Apply Result: $APPLY_RESULT"
          echo "Destroy Result: $DESTROY_RESULT"

          if [ "$ACTION" = "apply" ]; then
            case "$APPLY_RESULT" in
              "success")
                echo "status=success" >> $GITHUB_OUTPUT
                echo "message=Infrastructure deployed successfully" >> $GITHUB_OUTPUT
                ;;
              "failure")
                echo "status=failure" >> $GITHUB_OUTPUT
                echo "message=Deployment failed" >> $GITHUB_OUTPUT
                ;;
              "skipped")
                echo "status=skipped" >> $GITHUB_OUTPUT
                echo "message=Apply skipped (not triggered)" >> $GITHUB_OUTPUT
                ;;
              *)
                echo "status=unknown" >> $GITHUB_OUTPUT
                echo "message=Unknown apply status: $APPLY_RESULT" >> $GITHUB_OUTPUT
                ;;
            esac
          elif [ "$ACTION" = "destroy" ]; then
            case "$DESTROY_RESULT" in
              "success")
                echo "status=success" >> $GITHUB_OUTPUT
                echo "message=Infrastructure destroyed successfully" >> $GITHUB_OUTPUT
                ;;
              "failure")
                echo "status=failure" >> $GITHUB_OUTPUT
                echo "message=Destroy failed" >> $GITHUB_OUTPUT
                ;;
              "skipped")
                echo "status=blocked" >> $GITHUB_OUTPUT
                echo "message=Destroy blocked (production protection)" >> $GITHUB_OUTPUT
                ;;
              *)
                echo "status=unknown" >> $GITHUB_OUTPUT
                echo "message=Unknown destroy status: $DESTROY_RESULT" >> $GITHUB_OUTPUT
                ;;
            esac
          fi

          echo "Final Status: ${{ steps.status.outputs.status }}"
          echo "Message: ${{ steps.status.outputs.message }}"

      - name: Send Notification
        run: |
          echo "=========================================="
          echo "Deployment Workflow Complete"
          echo "=========================================="
          echo "Status: ${{ steps.status.outputs.status }}"
          echo "Message: ${{ steps.status.outputs.message }}"
          echo "Environment: ${{ needs.pre-check.outputs.env }}"
          echo "Action: ${{ needs.pre-check.outputs.action }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "=========================================="

